<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Events - Hexenj√§ger</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --Font: "Montserrat", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --White: #F1F1F1;
      --Dark: #151617;
      --Neutral: #F9F3DE;
      --Firmcolor: #EE2759;
      --Red: #FF4848;
      --Yellow: #FFDE2A;
      --Ice: #3581DB;
      --Grey: #6A6373;
      --Primary: #7c5bf1;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      border: 0;
      vertical-align: baseline;
      appearance: none;
      outline: 0;
      font-family: inherit;
    }

    body {
      font-family: var(--Font);
      background: #0d0b1b;
      color: var(--White);
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      width: 100%;
      padding: 0 20px;
      margin: 0 auto;
      position: relative;
    }

    /* Header mit Logo und Text */
    .header {
      background: var(--White);
      display: flex;
      padding: 8px 22px;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
      box-shadow: 0 12px 100px 0 rgba(0,0,0,.25);
      height: 80px;
    }

    .header__brand {
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
    }

    .header__logo img {
      height: 60px;
      width: auto;
    }

    .header__text {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .header__title {
      color: var(--Primary);
      font-size: 24px;
      font-weight: 900;
      text-transform: uppercase;
      line-height: 1;
    }

    .header__subtitle {
      color: var(--Dark);
      font-size: 14px;
      font-weight: 600;
      line-height: 1.2;
    }

    .header__nav {
      display: flex;
      gap: 8px;
    }

    .header__nav a {
      color: var(--Dark);
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: .64px;
      padding: 12px 20px;
      border-radius: 8px;
      transition: .2s;
      text-transform: uppercase;
      text-decoration: none;
    }

    .header__nav a:hover {
      background: var(--Yellow);
    }

    .header__nav a.active {
      background: var(--Primary);
      color: var(--White);
    }

    /* Leaderschaft Button */
    .leaderschaft-btn {
      background: var(--Primary);
      color: var(--White);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: .64px;
      text-transform: uppercase;
      cursor: pointer;
      transition: .2s;
      height: 44px;
    }

    .leaderschaft-btn:hover {
      background: linear-gradient(0deg, rgba(0,0,0,.2) 0, rgba(0,0,0,.2) 100%), var(--Primary);
    }

    /* Buttons */
    .btn {
      display: flex;
      padding: 12px 20px;
      gap: 8px;
      cursor: pointer;
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: .64px;
      border-radius: 8px;
      background: var(--Primary);
      color: var(--White);
      align-items: center;
      justify-content: center;
      transition: .2s;
      text-transform: uppercase;
      border: none;
      text-decoration: none;
    }

    .btn:hover {
      background: linear-gradient(0deg, rgba(0,0,0,.2) 0, rgba(0,0,0,.2) 100%), var(--Primary);
    }

    .btn-yellow {
      background: var(--Yellow);
      color: var(--Dark);
    }

    .btn-yellow:hover {
      background: linear-gradient(0deg, rgba(255,255,255,.4) 0%, rgba(255,255,255,.4) 100%), var(--Yellow);
    }

    .btn-red {
      background: var(--Red);
    }

    .btn-red:hover {
      background: linear-gradient(0deg, rgba(0,0,0,.2) 0, rgba(0,0,0,.2) 100%), var(--Red);
    }

    /* Main Content */
    .main-content {
      margin-top: 100px;
    }

    h1 {
      font-size: 36px;
      font-weight: 900;
      text-transform: uppercase;
      color: var(--White);
      margin-bottom: 30px;
    }

    h2 {
      font-size: 24px;
      font-weight: 800;
      margin: 20px 0;
      text-transform: uppercase;
      color: var(--Yellow);
    }

    /* Form Styles */
    .form-container {
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 24px;
      padding: 28px;
      backdrop-filter: blur(6px);
      margin: 20px 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 14px;
      color: var(--White);
    }

    input, select {
      padding: 12px 16px;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,.2);
      color: var(--White);
      font-size: 16px;
      width: 100%;
    }

    input:focus, select:focus {
      outline: 2px solid var(--Primary);
    }

    /* Table Styles */
    .table-container {
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 24px;
      padding: 24px;
      backdrop-filter: blur(6px);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    }

    th, td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }

    th {
      background: rgba(124,91,241,.2);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 14px;
      color: var(--Yellow);
    }

    tr:hover {
      background: rgba(124,91,241,.1);
    }

    /* Event Form Styles */
    .members-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .member-tag {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .member-tag:hover {
      background: rgba(124,91,241,.1);
    }

    .member-tag.selected {
      background: var(--Primary);
      border-color: var(--Primary);
    }

    .quick-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .quick-btn {
      padding: 8px 16px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 6px;
      color: var(--White);
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-btn:hover {
      background: rgba(124,91,241,.2);
    }

    .selected-count {
      color: var(--Yellow);
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .event-details {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .individual-inputs {
      margin-top: 15px;
    }

    .member-input {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .member-input label {
      min-width: 120px;
      margin-bottom: 0;
    }

    .member-input input {
      width: 100px;
      padding: 8px;
    }

    .preview-box {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .preview-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }

    .preview-item:last-child {
      border-bottom: none;
    }

    /* Event Prices Styles */
    .event-prices-container {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid rgba(255,255,255,.1);
    }

    .event-prices-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .event-price-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 8px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .event-price-info {
      flex: 1;
    }

    .event-price-name {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .event-price-description {
      color: var(--Grey);
      font-size: 0.85em;
    }

    .event-price-input {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .event-price-input input {
      width: 120px;
      padding: 8px;
      text-align: right;
    }

    .price-unit {
      color: var(--Grey);
      font-size: 0.9em;
      min-width: 60px;
    }

    .admin-only { 
      display: none; 
      visibility: hidden; 
      opacity: 0; 
      transition: opacity 0.3s ease;
    }
    body.admin .admin-only { 
      display: block; 
      visibility: visible; 
      opacity: 1; 
    }

    /* Responsive */
    @media (max-width: 1040px) {
      .header__nav { display: none; }
      .header__text { display: none; }
    }

    @media (max-width: 768px) {
      .table-container {
        padding: 16px;
        overflow-x: auto;
      }
      
      table {
        min-width: 600px;
      }
      
      th, td {
        padding: 12px 8px;
      }

      .members-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }

      .event-prices-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header mit Logo und Text -->
  <div class="header">
    <div class="header__brand" onclick="window.location.href='index.html'">
      <div class="header__logo">
        <img src="logo.png" alt="Hexenj√§ger Logo" onerror="this.style.display='none'">
      </div>
      <div class="header__text">
        <div class="header__title">Hexenj√§ger</div>
        <div class="header__subtitle">Grand Roleplay<br>GTA5</div>
      </div>
    </div>
    
    <div class="header__nav">
      <a href="auszahlung.html">Auszahlungen</a>
      <a href="statistik.html">Statistik</a>
      <a href="events.html" class="active">Events</a>
      <a href="mitglieder.html" class="admin-only">Mitglieder</a>
    </div>

    <button class="leaderschaft-btn" id="leaderschaftBtn">LEADERSCHAFT</button>
  </div>

  <div class="container main-content">
    <h1>üìÖ Events</h1>

    <div class="admin-only">
      <!-- Event Form mit erweiterten Funktionen -->
      <div class="form-container">
        <h2>Neues Event erfassen</h2>
        
        <!-- Event Typ -->
        <div class="form-group">
          <label for="eventType">Event Typ</label>
          <select id="eventType">
            <option value="">-- Event ausw√§hlen --</option>
            <option value="bizwar_win">Bizwar Win</option>
            <option value="bizwar_lose">Bizwar Lose</option>
            <option value="40er_win">40er Win</option>
            <option value="40er_lose">40er Lose</option>
            <option value="ekz">EKZ</option>
            <option value="hafen">Hafen</option>
            <option value="giesserei">Gie√üerei</option>
            <option value="waffenfabrik">Waffenfabrik</option>
            <option value="cayo">Cayo Perico</option>
            <option value="rp_fabrik">RP Fabrik</option>
          </select>
        </div>

        <!-- Mitglieder Auswahl -->
        <div class="form-group">
          <label>Mitglieder ausw√§hlen</label>
          <div class="quick-actions">
            <button type="button" class="quick-btn" onclick="selectAllMembers()">Alle ausw√§hlen</button>
            <button type="button" class="quick-btn" onclick="deselectAllMembers()">Alle abw√§hlen</button>
          </div>
          <div class="selected-count" id="selectedCount">0 Mitglieder ausgew√§hlt</div>
          <div class="members-grid" id="membersGrid">
            <!-- Wird via JavaScript gef√ºllt -->
          </div>
        </div>

        <!-- Event Details -->
        <div id="eventDetails" class="event-details" style="display: none;">
          <!-- Gemeinsame Eingabe f√ºr Cayo, RP Fabrik -->
          <div id="sharedAmount" style="display: none;">
            <div class="form-group">
              <label for="sharedAmountInput" id="sharedAmountLabel">Anzahl</label>
              <input type="number" id="sharedAmountInput" min="1" value="1">
            </div>
            <div class="form-group">
              <label for="sharedTotalAmount">Gesamtbetrag (‚Ç¨)</label>
              <input type="number" id="sharedTotalAmount" min="1" placeholder="Gesamtbetrag eingeben">
            </div>
          </div>

          <!-- Individuelle Eingabe f√ºr Kills/Drops/Wins -->
          <div id="individualAmounts" style="display: none;">
            <div class="form-group">
              <label id="individualAmountLabel">Anzahl pro Mitglied</label>
            </div>
            <div class="individual-inputs" id="individualInputsContainer">
              <!-- Wird via JavaScript gef√ºllt -->
            </div>
          </div>
        </div>

        <!-- Vorschau -->
        <div id="previewSection" class="preview-box" style="display: none;">
          <h3 style="margin-bottom: 15px; color: var(--Yellow);">Vorschau</h3>
          <div id="previewContent"></div>
        </div>

        <!-- Aktionen -->
        <div style="display: flex; gap: 12px; margin-top: 25px;">
          <button id="submitEvent" class="btn" style="flex: 1;">Event speichern</button>
          <button type="button" onclick="resetForm()" class="btn btn-secondary">Zur√ºcksetzen</button>
        </div>
        
        <div id="statusMessage" style="margin-top: 15px; text-align: center; display: none;"></div>
      </div>

      <!-- Event-Preise Verwaltung -->
      <div class="event-prices-container">
        <h3>Event-Preise verwalten</h3>
        <p>Aktuelle Auszahlungsbetr√§ge pro Event-Typ</p>
        
        <div class="event-prices-grid" id="eventPricesGrid">
          <!-- Wird via JavaScript gef√ºllt -->
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button onclick="saveEventPrices()" class="btn">Preise speichern</button>
          <button onclick="resetEventPrices()" class="btn btn-secondary">Standard-Preise</button>
        </div>
        
        <div id="pricesStatusMessage" style="margin-top: 15px; text-align: center; display: none;"></div>
      </div>
    </div>

    <!-- Letzte Events -->
    <h2>Letzte Events</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Event</th>
            <th>Mitglied</th>
            <th>Betrag</th>
            <th>Datum</th>
            <th class="admin-only">Aktionen</th>
          </tr>
        </thead>
        <tbody id="eventsTable">
          <!-- Wird mit JavaScript gef√ºllt -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCB909WgDGPh1KE6lMpZshQ1BmzoTYR2Ic",
      authDomain: "hexenjaeger-dashboard.firebaseapp.com",
      projectId: "hexenjaeger-dashboard",
      storageBucket: "hexenjaeger-dashboard.firebasestorage.app",
      messagingSenderId: "48507598074",
      appId: "1:48507598074:web:d736c118fd74d1968d0543"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let selectedMembers = [];
    let currentMembers = [];

    // Event-Preis Konfiguration mit Standardwerten
    const defaultEventPrices = {
      'bizwar_win': { price: 50000, description: 'Pro Kill (Win)', unit: 'pro Kill' },
      'bizwar_lose': { price: 25000, description: 'Pro Kill (Lose)', unit: 'pro Kill' },
      '40er_win': { price: 40000, description: 'Pro Kill (Win)', unit: 'pro Kill' },
      '40er_lose': { price: 20000, description: 'Pro Kill (Lose)', unit: 'pro Kill' },
      'giesserei': { price: 30000, description: 'Pro Kill', unit: 'pro Kill' },
      'waffenfabrik': { price: 35000, description: 'Pro Kill', unit: 'pro Kill' },
      'hafen': { price: 100000, description: 'Pro Drop', unit: 'pro Drop' },
      'ekz': { price: 150000, description: 'Pro Win', unit: 'pro Win' }
    };

    // Auth Check
    auth.onAuthStateChanged(user => {
      document.body.classList.toggle('admin', !!user);
      
      if (user) {
        loadMembers();
        loadRecentEvents();
        loadEventPrices();
      }
    });

    // Mitglieder laden
    function loadMembers() {
      db.collection('members').onSnapshot(snap => {
        currentMembers = [];
        const membersGrid = document.getElementById('membersGrid');
        membersGrid.innerHTML = '';
        
        snap.forEach(doc => {
          const member = { id: doc.id, ...doc.data() };
          currentMembers.push(member);
          
          const memberTag = document.createElement('div');
          memberTag.className = 'member-tag';
          memberTag.dataset.id = member.id;
          memberTag.innerHTML = `
            <span>${member.name}</span>
            <small style="color: var(--Grey);">(${member.id || 'No ID'})</small>
          `;
          
          memberTag.addEventListener('click', function() {
            const memberId = this.dataset.id;
            
            if (this.classList.contains('selected')) {
              // Abw√§hlen
              this.classList.remove('selected');
              selectedMembers = selectedMembers.filter(id => id !== memberId);
            } else {
              // Ausw√§hlen
              this.classList.add('selected');
              selectedMembers.push(memberId);
            }
            
            updateSelectedCount();
            updateIndividualInputs();
            updatePreview();
          });
          
          membersGrid.appendChild(memberTag);
        });
      });
    }

    // Letzte Events laden
    function loadRecentEvents() {
      db.collection('transactions')
        .orderBy('timestamp', 'desc')
        .limit(10)
        .onSnapshot(snap => {
          const container = document.getElementById('eventsTable');
          container.innerHTML = '';
          
          snap.forEach(doc => {
            const transaction = doc.data();
            const row = document.createElement('tr');
            
            const eventNames = {
              'bizwar_win': 'Bizwar Win', 'bizwar_lose': 'Bizwar Lose',
              '40er_win': '40er Win', '40er_lose': '40er Lose',
              'hafen': 'Hafen', 'giesserei': 'Gie√üerei', 
              'waffenfabrik': 'Waffenfabrik', 'ekz': 'EKZ',
              'cayo': 'Cayo Perico', 'rp_fabrik': 'RP Fabrik'
            };
            
            row.innerHTML = `
              <td>${eventNames[transaction.event] || transaction.event}</td>
              <td>${transaction.member}</td>
              <td style="color: var(--Yellow); font-weight: 700;">${(transaction.amount || 0).toLocaleString('de-DE')} ‚Ç¨</td>
              <td>${new Date(transaction.timestamp).toLocaleDateString('de-DE')}</td>
              <td class="admin-only">
                <button class="btn btn-red" onclick="deleteTransaction('${doc.id}')">L√∂schen</button>
              </td>
            `;
            container.appendChild(row);
          });
        });
    }

    // Event-Preise laden
    function loadEventPrices() {
      // In einer echten Implementierung w√ºrden die Preise aus Firebase geladen
      // F√ºr dieses Beispiel verwenden wir localStorage
      let eventPrices = JSON.parse(localStorage.getItem('hexenjaeger_event_prices')) || defaultEventPrices;
      
      const grid = document.getElementById('eventPricesGrid');
      
      const eventNames = {
        'bizwar_win': 'Bizwar Win',
        'bizwar_lose': 'Bizwar Lose',
        '40er_win': '40er Win',
        '40er_lose': '40er Lose',
        'giesserei': 'Gie√üerei',
        'waffenfabrik': 'Waffenfabrik',
        'hafen': 'Hafen',
        'ekz': 'EKZ'
      };
      
      grid.innerHTML = Object.entries(eventPrices)
        .filter(([eventType]) => eventType in eventNames)
        .map(([eventType, config]) => `
          <div class="event-price-item">
            <div class="event-price-info">
              <div class="event-price-name">${eventNames[eventType]}</div>
              <div class="event-price-description">${config.description}</div>
            </div>
            <div class="event-price-input">
              <input type="number" id="price_${eventType}" value="${config.price}" min="0" step="1000">
              <span class="price-unit">${config.unit}</span>
            </div>
          </div>
        `).join('');

      grid.innerHTML += `
        <div class="event-price-item" style="grid-column: 1 / -1; background: rgba(0,0,0,0.3);">
          <div class="event-price-info">
            <div class="event-price-name">Cayo Perico & RP Fabrik</div>
            <div class="event-price-description">Preise werden pro Event individuell festgelegt</div>
          </div>
          <div class="event-price-input">
            <span class="price-unit" style="color: var(--Grey);">Variable Preise</span>
          </div>
        </div>
      `;
    }

    // Hilfsfunktionen
    function getEventPrice(eventType, amount = 1) {
      const eventPrices = JSON.parse(localStorage.getItem('hexenjaeger_event_prices')) || defaultEventPrices;
      const config = eventPrices[eventType];
      return config ? config.price * amount : 0;
    }

    function formatCurrency(amount) {
      return amount.toLocaleString('de-DE') + ' ‚Ç¨';
    }

    function updateSelectedCount() {
      const count = selectedMembers.length;
      document.getElementById('selectedCount').textContent = `${count} Mitglieder ausgew√§hlt`;
    }

    function selectAllMembers() {
      selectedMembers = currentMembers.map(m => m.id);
      document.querySelectorAll('.member-tag').forEach(tag => {
        tag.classList.add('selected');
      });
      updateSelectedCount();
      updateIndividualInputs();
      updatePreview();
    }

    function deselectAllMembers() {
      selectedMembers = [];
      document.querySelectorAll('.member-tag').forEach(tag => {
        tag.classList.remove('selected');
      });
      updateSelectedCount();
      updateIndividualInputs();
      updatePreview();
    }

    function updateIndividualInputs() {
      const container = document.getElementById('individualInputsContainer');
      container.innerHTML = '';
      
      selectedMembers.forEach(memberId => {
        const member = currentMembers.find(m => m.id === memberId);
        if (member) {
          const inputHtml = `
            <div class="member-input">
              <label>${member.name}:</label>
              <input type="number" id="amount_${memberId}" min="1" value="1" oninput="updatePreview()">
            </div>
          `;
          container.innerHTML += inputHtml;
        }
      });
      updatePreview();
    }

    function updatePreview() {
      const previewSection = document.getElementById('previewSection');
      const previewContent = document.getElementById('previewContent');
      const eventType = document.getElementById('eventType');
      
      if (!eventType.value || selectedMembers.length === 0) {
        previewSection.style.display = 'none';
        return;
      }

      const eventTypeValue = eventType.value;
      let totalPayout = 0;
      let description = '';

      // Shared Events (Cayo, RP Fabrik)
      if (['cayo', 'rp_fabrik'].includes(eventTypeValue)) {
        const amount = parseInt(document.getElementById('sharedAmountInput').value) || 1;
        const totalAmount = parseInt(document.getElementById('sharedTotalAmount').value) || 0;
        
        if (totalAmount > 0) {
          const perMember = Math.round(totalAmount / selectedMembers.length);
          totalPayout = totalAmount;
          
          const eventNames = {
            'cayo': 'Cayo Perico',
            'rp_fabrik': 'RP Fabrik'
          };
          
          const unit = eventTypeValue === 'cayo' ? 'Drops' : 'Wins';
          description = `${eventNames[eventTypeValue]} - ${amount} ${unit}`;
          
          previewContent.innerHTML = `
            <div class="preview-item">
              <span>${selectedMembers.length} Mitglieder</span>
              <span>${formatCurrency(perMember)} pro Person</span>
            </div>
            <div class="preview-item">
              <span>Gesamtbetrag</span>
              <span><strong>${formatCurrency(totalPayout)}</strong></span>
            </div>
          `;
        }
      } 
      // Individuelle Events (Bizwar, 40er, Hafen, Gie√üerei, Waffenfabrik, EKZ)
      else {
        let individualAmounts = [];
        selectedMembers.forEach(memberId => {
          const amount = parseInt(document.getElementById(`amount_${memberId}`)?.value) || 1;
          const amountValue = getEventPrice(eventTypeValue, amount);
          individualAmounts.push({
            memberId: memberId,
            amount: amount,
            amountValue: amountValue
          });
          totalPayout += amountValue;
        });

        const eventNames = {
          'bizwar_win': 'Bizwar Win', 'bizwar_lose': 'Bizwar Lose',
          '40er_win': '40er Win', '40er_lose': '40er Lose',
          'hafen': 'Hafen', 'giesserei': 'Gie√üerei', 
          'waffenfabrik': 'Waffenfabrik', 'ekz': 'EKZ'
        };
        
        description = eventNames[eventTypeValue];
        
        previewContent.innerHTML = individualAmounts.map(item => {
          const member = currentMembers.find(m => m.id === item.memberId);
          let unit = 'Kills';
          if (eventTypeValue.includes('hafen')) unit = 'Drops';
          if (eventTypeValue === 'ekz') unit = 'Wins';
          
          return `
            <div class="preview-item">
              <span>${member.name} (${item.amount} ${unit})</span>
              <span>${formatCurrency(item.amountValue)}</span>
            </div>
          `;
        }).join('') + `
          <div class="preview-item" style="border-top: 2px solid var(--Primary); font-weight: bold; margin-top: 10px;">
            <span>Gesamt (${selectedMembers.length} Mitglieder)</span>
            <span>${formatCurrency(totalPayout)}</span>
          </div>
        `;
      }

      if (totalPayout > 0) {
        previewSection.style.display = 'block';
      } else {
        previewSection.style.display = 'none';
      }
    }

    function resetForm() {
      document.getElementById('eventType').value = '';
      selectedMembers = [];
      document.querySelectorAll('.member-tag').forEach(tag => {
        tag.classList.remove('selected');
      });
      document.getElementById('sharedAmountInput').value = '1';
      document.getElementById('sharedTotalAmount').value = '';
      updateSelectedCount();
      updatePreview();
      document.getElementById('eventDetails').style.display = 'none';
      document.getElementById('previewSection').style.display = 'none';
    }

    function saveEventPrices() {
      const eventPrices = {};
      const eventTypes = Object.keys(defaultEventPrices);
      
      eventTypes.forEach(eventType => {
        const input = document.getElementById(`price_${eventType}`);
        if (input) {
          const price = parseInt(input.value) || 0;
          eventPrices[eventType] = {
            price: price,
            description: defaultEventPrices[eventType].description,
            unit: defaultEventPrices[eventType].unit
          };
        }
      });
      
      localStorage.setItem('hexenjaeger_event_prices', JSON.stringify(eventPrices));
      showPricesStatus('Event-Preise erfolgreich gespeichert!', 'success');
    }

    function resetEventPrices() {
      localStorage.setItem('hexenjaeger_event_prices', JSON.stringify(defaultEventPrices));
      loadEventPrices();
      showPricesStatus('Standard-Preise wiederhergestellt!', 'success');
    }

    function showPricesStatus(message, type) {
      const statusElement = document.getElementById('pricesStatusMessage');
      statusElement.textContent = message;
      statusElement.style.color = type === 'success' ? '#10b981' : '#ef4444';
      statusElement.style.display = 'block';
      setTimeout(() => statusElement.style.display = 'none', 4000);
    }

    function showStatus(message, type) {
      const statusElement = document.getElementById('statusMessage');
      statusElement.textContent = message;
      statusElement.style.color = type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#ef4444';
      statusElement.style.display = 'block';
      setTimeout(() => statusElement.style.display = 'none', 4000);
    }

    function deleteTransaction(transactionId) {
      if (!confirm('Diese Transaktion wirklich l√∂schen?')) return;
      
      db.collection('transactions').doc(transactionId).delete()
        .then(() => {
          showStatus('Transaktion gel√∂scht!', 'success');
        })
        .catch(error => {
          showStatus('Fehler: ' + error.message, 'error');
        });
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      const eventType = document.getElementById('eventType');
      const submitBtn = document.getElementById('submitEvent');

      // Event Type Change
      eventType.addEventListener('change', function() {
        const sharedAmount = document.getElementById('sharedAmount');
        const individualAmounts = document.getElementById('individualAmounts');
        const sharedAmountLabel = document.getElementById('sharedAmountLabel');
        const individualAmountLabel = document.getElementById('individualAmountLabel');
        const eventDetails = document.getElementById('eventDetails');
        
        if (this.value) {
          eventDetails.style.display = 'block';
          
          const eventConfig = {
            'bizwar_win': { shared: false, label: 'Kills pro Mitglied' },
            'bizwar_lose': { shared: false, label: 'Kills pro Mitglied' },
            '40er_win': { shared: false, label: 'Kills pro Mitglied' },
            '40er_lose': { shared: false, label: 'Kills pro Mitglied' },
            'ekz': { shared: false, label: 'Wins pro Mitglied' },
            'hafen': { shared: false, label: 'Drops pro Mitglied' },
            'giesserei': { shared: false, label: 'Kills pro Mitglied' },
            'waffenfabrik': { shared: false, label: 'Kills pro Mitglied' },
            'cayo': { shared: true, label: 'Drops' },
            'rp_fabrik': { shared: true, label: 'Wins' }
          };

          const config = eventConfig[this.value];
          
          if (config.shared) {
            sharedAmount.style.display = 'block';
            individualAmounts.style.display = 'none';
            sharedAmountLabel.textContent = config.label;
          } else {
            sharedAmount.style.display = 'none';
            individualAmounts.style.display = 'block';
            individualAmountLabel.textContent = config.label;
            updateIndividualInputs();
          }
        } else {
          eventDetails.style.display = 'none';
        }
        
        updatePreview();
      });

      // Input Listener f√ºr Live-Vorschau
      document.getElementById('sharedAmountInput')?.addEventListener('input', updatePreview);
      document.getElementById('sharedTotalAmount')?.addEventListener('input', updatePreview);

      // Event speichern
      submitBtn.addEventListener('click', async function() {
        if (!eventType.value) {
          showStatus('Bitte Event-Typ ausw√§hlen', 'error');
          return;
        }

        if (selectedMembers.length === 0) {
          showStatus('Bitte Mitglieder ausw√§hlen', 'error');
          return;
        }

        const eventTypeValue = eventType.value;

        try {
          // Shared Events (Cayo, RP Fabrik)
          if (['cayo', 'rp_fabrik'].includes(eventTypeValue)) {
            const amount = parseInt(document.getElementById('sharedAmountInput').value) || 1;
            const totalAmount = parseInt(document.getElementById('sharedTotalAmount').value) || 0;

            if (totalAmount === 0) {
              showStatus('Bitte Gesamtbetrag eingeben', 'error');
              return;
            }

            const perMember = Math.round(totalAmount / selectedMembers.length);

            // F√ºr jeden Teilnehmer Transaktion erstellen
            for (const memberId of selectedMembers) {
              const member = currentMembers.find(m => m.id === memberId);
              if (member) {
                // Mitglieder-Balance aktualisieren
                const memberRef = db.collection('members').doc(memberId);
                const memberDoc = await memberRef.get();
                
                if (memberDoc.exists) {
                  const currentBalance = memberDoc.data().balance || 0;
                  await memberRef.update({
                    balance: currentBalance + perMember
                  });

                  // Transaktion speichern
                  await db.collection('transactions').add({
                    member: member.name,
                    type: 'einzahlung',
                    event: eventTypeValue,
                    amount: perMember,
                    quantity: amount,
                    participants: selectedMembers.length,
                    timestamp: new Date().toISOString(),
                    description: `${eventTypeValue} - ${amount} ${eventTypeValue === 'cayo' ? 'Drops' : 'Wins'}`
                  });
                }
              }
            }

            showStatus(`Event f√ºr ${selectedMembers.length} Mitglieder gespeichert! Gesamt: ${formatCurrency(totalAmount)}`, 'success');
            resetForm();
          } 
          // Individuelle Events (Bizwar, 40er, Hafen, Gie√üerei, Waffenfabrik, EKZ)
          else {
            let successCount = 0;
            let totalCalculated = 0;

            for (const memberId of selectedMembers) {
              const member = currentMembers.find(m => m.id === memberId);
              if (member) {
                const amount = parseInt(document.getElementById(`amount_${memberId}`).value) || 1;
                const amountValue = getEventPrice(eventTypeValue, amount);

                // Mitglieder-Balance aktualisieren
                const memberRef = db.collection('members').doc(memberId);
                const memberDoc = await memberRef.get();
                
                if (memberDoc.exists) {
                  const currentBalance = memberDoc.data().balance || 0;
                  await memberRef.update({
                    balance: currentBalance + amountValue
                  });

                  // Transaktion speichern
                  await db.collection('transactions').add({
                    member: member.name,
                    type: 'einzahlung',
                    event: eventTypeValue,
                    amount: amountValue,
                    quantity: amount,
                    participants: 1,
                    timestamp: new Date().toISOString(),
                    description: `${eventTypeValue} - ${amount} ${eventTypeValue === 'ekz' ? 'Wins' : eventTypeValue.includes('hafen') ? 'Drops' : 'Kills'}`
                  });

                  successCount++;
                  totalCalculated += amountValue;
                }
              }
            }

            if (successCount === selectedMembers.length) {
              showStatus(`Event f√ºr ${successCount} Mitglieder gespeichert! Gesamt: ${formatCurrency(totalCalculated)}`, 'success');
              resetForm();
            } else {
              showStatus(`Event f√ºr ${successCount}/${selectedMembers.length} Mitgliedern gespeichert`, 'warning');
            }
          }
        } catch (error) {
          showStatus('Fehler: ' + error.message, 'error');
        }
      });

      // Leaderschaft Button Event
      document.getElementById('leaderschaftBtn').onclick = () => {
        alert('Bitte auf dem Dashboard einloggen');
      };
    });
  </script>
</body>
</html>
