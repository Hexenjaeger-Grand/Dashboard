<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hexenj√§ger Family</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            border-color: var(--accent-purple);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .card-icon {
            font-size: 2em;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
        }

        .card-title {
            color: var(--text-light);
            font-size: 1.2em;
            font-weight: 600;
            margin: 0;
        }

        .card-value {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--accent-purple-light);
            margin: 10px 0;
        }

        .card-label {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--bg-darker);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.8em;
        }

        .recent-activity {
            margin-top: 20px;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 6px;
            font-size: 1.1em;
        }

        .activity-details {
            display: flex;
            flex-direction: column;
        }

        .activity-member {
            font-weight: 600;
            color: var(--text-light);
        }

        .activity-event {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .activity-amount {
            font-weight: bold;
            color: var(--accent-purple-light);
        }

        .no-activity {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }

        /* Passwort Screen Styles */
        .password-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .password-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .password-header h1 {
            color: var(--accent-purple-light);
            margin-bottom: 10px;
        }

        .password-header p {
            color: var(--text-muted);
            margin-bottom: 30px;
        }

        .password-form {
            margin-bottom: 30px;
        }

        #passwordInput {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            text-align: center;
            letter-spacing: 3px;
            font-weight: bold;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-darker);
            color: var(--text-light);
        }

        .password-info {
            text-align: left;
            background: var(--bg-darker);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .password-info ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .password-info li {
            margin-bottom: 5px;
        }

        .password-note {
            margin-top: 15px;
            padding: 10px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 6px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <!-- Passwort-Abfrage Screen -->
    <div id="passwordOverlay" style="display: none;">
        <div class="password-container">
            <div class="password-box">
                <div class="password-header">
                    <h1>üîê Hexenj√§ger Event-System</h1>
                    <p>Bitte gib das aktuelle Zugangspasswort ein</p>
                </div>
                
                <div class="password-form">
                    <input type="password" id="passwordInput" placeholder="Aktuelles Passwort eingeben" maxlength="6">
                    <button onclick="checkPassword()" class="btn btn-primary">üîì Zugang</button>
                </div>
                
                <div class="password-info">
                    <p>üí° <strong>Passwort bekommen:</strong></p>
                    <ol>
                        <li>Gehe in den Hexenj√§ger Discord</li>
                        <li>Finde den Passwort-Embed</li>
                        <li>Klicke auf "üîë Passwort anfordern"</li>
                        <li>Du erh√§ltst das aktuelle Passwort</li>
                    </ol>
                    <p class="password-note">‚ö†Ô∏è Das Passwort wechselt alle 24 Stunden automatisch!</p>
                </div>
                
                <div id="passwordError" class="error-message" style="display: none;">
                    ‚ùå Falsches Passwort oder abgelaufen!
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="hexenjaeger-symbol"></div>
            <h1>Hexenj√§ger Family</h1>
            <p>Event Management & Auszahlungssystem</p>
        </header>

        <!-- Hauptnavigation -->
        <nav class="main-nav">
            <a href="eingabe.html" class="nav-card">
                <span class="nav-icon">üìù</span>
                <h3>Event Eingabe</h3>
                <p>Neue Events f√ºr Mitglieder erfassen</p>
            </a>

            <a href="auszahlungen.html" class="nav-card">
                <span class="nav-icon">üí∞</span>
                <h3>Auszahlungen</h3>
                <p>Offene Auszahlungen verwalten</p>
            </a>

            <a href="mitglieder.html" class="nav-card">
                <span class="nav-icon">üë•</span>
                <h3>Mitglieder</h3>
                <p>Family Mitglieder verwalten</p>
            </a>

            <a href="statistik.html" class="nav-card">
                <span class="nav-icon">üìä</span>
                <h3>Statistik</h3>
                <p>Daten analysieren und einsehen</p>
            </a>
        </nav>

        <!-- Dashboard √úbersicht -->
        <div class="dashboard-grid">
            <!-- Offene Auszahlungen -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon">üí∞</div>
                    <h3 class="card-title">Offene Auszahlungen</h3>
                </div>
                <div class="card-value" id="openPayoutsCount">0</div>
                <div class="card-label">Gesamtbetrag: <span id="openPayoutsAmount">$0</span></div>
                
                <div class="quick-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="affectedMembers">0</div>
                        <div class="stat-label">Betroffene Mitglieder</div>
                    </div>
                </div>
            </div>

            <!-- Mitglieder Statistik -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon">üë•</div>
                    <h3 class="card-title">Mitglieder</h3>
                </div>
                <div class="card-value" id="totalMembers">0</div>
                <div class="card-label">Aktive Family Mitglieder</div>
                
                <div class="quick-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="activeMembers">0</div>
                        <div class="stat-label">Mit offenen Auszahlungen</div>
                    </div>
                </div>
            </div>

            <!-- Abgeschlossene Auszahlungen -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon">‚úÖ</div>
                    <h3 class="card-title">Abgeschlossen</h3>
                </div>
                <div class="card-value" id="completedPayouts">0</div>
                <div class="card-label">Ausgezahlte Betr√§ge</div>
                
                <div class="quick-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalPaid">$0</div>
                        <div class="stat-label">Gesamt ausgezahlt</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aktuelle Aktivit√§t -->
        <div class="card">
            <h2>Letzte Aktivit√§t</h2>
            <div class="recent-activity" id="recentActivity">
                <!-- Wird via JavaScript gef√ºllt -->
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Passwort-√úberpr√ºfung
        function checkPassword() {
            const password = document.getElementById('passwordInput').value.trim().toUpperCase();
            const errorElement = document.getElementById('passwordError');
            
            // Hier w√ºrdest du das Passwort gegen den Bot validieren
            // F√ºr jetzt simulieren wir das mit localStorage
            const isValid = validatePasswordWithBot(password);
            
            if (isValid) {
                // Zugang gew√§hrt - Passwort f√ºr 24h speichern
                localStorage.setItem('hj_access', password);
                localStorage.setItem('hj_access_time', Date.now());
                document.getElementById('passwordOverlay').style.display = 'none';
            } else {
                errorElement.style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        function validatePasswordWithBot(password) {
            // In der echten Version: API Call zum Bot
            // F√ºr Simulation: Pr√ºfe gegen gespeichertes Passwort
            const storedPassword = localStorage.getItem('hj_access');
            const storedTime = localStorage.getItem('hj_access_time');
            
            if (storedPassword && storedTime) {
                // Pr√ºfe ob weniger als 24 Stunden vergangen
                const timePassed = Date.now() - parseInt(storedTime);
                if (timePassed < 24 * 60 * 60 * 1000 && password === storedPassword) {
                    return true;
                }
            }
            
            // Falls keine lokale Validierung: immer false (in Produktion: Bot-API call)
            return false;
        }

        function checkAccess() {
            const password = localStorage.getItem('hj_access');
            const storedTime = localStorage.getItem('hj_access_time');
            
            if (!password || !storedTime) {
                showPasswordScreen();
                return false;
            }
            
            // Pr√ºfe ob Passwort √§lter als 24 Stunden
            const timePassed = Date.now() - parseInt(storedTime);
            if (timePassed > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('hj_access');
                localStorage.removeItem('hj_access_time');
                showPasswordScreen();
                return false;
            }
            
            return true;
        }

        function showPasswordScreen() {
            document.getElementById('passwordOverlay').style.display = 'flex';
            document.getElementById('passwordInput').focus();
        }

        // Enter-Taste f√ºr Passwort-Eingabe
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // Dashboard Funktionen
        function updateDashboard() {
            const members = db.getMembers();
            const events = db.getEvents();
            const completedPayouts = db.getCompletedPayouts();

            // Berechne offene Auszahlungen
            const memberPayouts = {};
            let totalOpenAmount = 0;
            
            events.forEach(event => {
                const eventType = event.eventType;
                const amount = event.amount || 1;
                const totalAmount = event.totalAmount || 0;
                
                let calculatedAmount = 0;
                if (['cayo', 'rp_fabrik', 'ekz'].includes(eventType)) {
                    calculatedAmount = totalAmount > 0 ? Math.round(totalAmount / event.memberIds.length) : 0;
                } else {
                    calculatedAmount = db.getEventPrice(eventType, amount);
                }
                
                event.memberIds.forEach(memberId => {
                    if (!memberPayouts[memberId]) {
                        memberPayouts[memberId] = 0;
                    }
                    memberPayouts[memberId] += calculatedAmount;
                    totalOpenAmount += calculatedAmount;
                });
            });

            // Update Dashboard Werte
            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('openPayoutsCount').textContent = events.length;
            document.getElementById('affectedMembers').textContent = Object.keys(memberPayouts).length;
            document.getElementById('openPayoutsAmount').textContent = formatCurrency(totalOpenAmount);
            document.getElementById('completedPayouts').textContent = completedPayouts.length;
            
            const totalPaid = completedPayouts.reduce((sum, payout) => sum + payout.total, 0);
            document.getElementById('totalPaid').textContent = formatCurrency(totalPaid);

            // Aktive Mitglieder (mit offenen Auszahlungen)
            const activeMembers = members.filter(member => memberPayouts[member.id]);
            document.getElementById('activeMembers').textContent = activeMembers.length;

            // Zeige letzte Aktivit√§t
            updateRecentActivity(events);
        }

        function updateRecentActivity(events) {
            const activityContainer = document.getElementById('recentActivity');
            const recentEvents = events.slice(-5).reverse(); // Letzte 5 Events

            if (recentEvents.length === 0) {
                activityContainer.innerHTML = `
                    <div class="no-activity">
                        Noch keine Aktivit√§t<br>
                        <small>Erfasse dein erstes Event!</small>
                    </div>
                `;
                return;
            }

            activityContainer.innerHTML = recentEvents.map(event => {
                const eventNames = {
                    'bizwar_win': 'Bizwar Win', 'bizwar_lose': 'Bizwar Lose',
                    '40er_win': '40er Win', '40er_lose': '40er Lose',
                    'giesserei': 'Gie√üerei', 'waffenfabrik': 'Waffenfabrik',
                    'hafen': 'Hafen', 'cayo': 'Cayo Perico', 
                    'rp_fabrik': 'RP Fabrik', 'ekz': 'EKZ'
                };

                const eventIcon = {
                    'bizwar_win': '‚öîÔ∏è', 'bizwar_lose': '‚öîÔ∏è',
                    '40er_win': 'üî´', '40er_lose': 'üî´',
                    'giesserei': 'üè≠', 'waffenfabrik': 'üî´',
                    'hafen': '‚öì', 'cayo': 'üèùÔ∏è', 
                    'rp_fabrik': 'üè≠', 'ekz': 'üéØ'
                };

                const memberNames = event.memberIds.map(id => {
                    const member = db.getMembers().find(m => m.id === id);
                    return member ? member.name : 'Unbekannt';
                }).join(', ');

                const eventName = eventNames[event.eventType] || event.eventType;
                const amount = event.amount || 1;
                const unit = event.eventType.includes('hafen') ? 'Drops' : 
                            event.eventType === 'ekz' ? 'Wins' : 'Kills';

                let calculatedAmount = 0;
                if (['cayo', 'rp_fabrik', 'ekz'].includes(event.eventType)) {
                    calculatedAmount = event.totalAmount > 0 ? Math.round(event.totalAmount / event.memberIds.length) : 0;
                } else {
                    calculatedAmount = db.getEventPrice(event.eventType, amount);
                }

                const timeAgo = getTimeAgo(new Date(event.date));

                return `
                    <div class="activity-item">
                        <div class="activity-info">
                            <div class="activity-icon">${eventIcon[event.eventType] || 'üéØ'}</div>
                            <div class="activity-details">
                                <div class="activity-member">${memberNames}</div>
                                <div class="activity-event">${eventName} - ${amount} ${unit}</div>
                            </div>
                        </div>
                        <div class="activity-amount">${formatCurrency(calculatedAmount)}</div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Gerade eben';
            if (diffMins < 60) return `Vor ${diffMins} min`;
            if (diffHours < 24) return `Vor ${diffHours} h`;
            if (diffDays === 1) return 'Gestern';
            return `Vor ${diffDays} Tagen`;
        }

        // Initialisiere Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Erst Passwort pr√ºfen
            if (!checkAccess()) {
                return;
            }
            
            // Dann Dashboard laden
            updateDashboard();
        });
    </script>
</body>
</html>
